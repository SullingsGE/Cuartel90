<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CENTRAL DE DESPACHO - CHASCOMÚS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
    <style>
        :root {
            --primary: #e67e22;
            --danger: #c0392b;
            --dark-panel: rgba(15, 15, 15, 0.95);
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Segoe UI', sans-serif;
            background: #000; overflow: hidden;
        }

        /* FONDO DEL CUARTEL (Se ve cuando el despacho está cerrado) */
        .bg-cuartel {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('cuartel.jpg') no-repeat center center;
            background-size: cover;
            filter: blur(10px) brightness(0.4);
            z-index: 1;
            transform: scale(1.1);
            transition: opacity 0.5s ease;
        }

        /* MAPA (Tapa la foto cuando se abre el despacho) */
        #map {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5;
            display: none;
        }

        /* INTERFAZ PRINCIPAL */
        .main-ui {
            position: relative;
            z-index: 20;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        /* BOTÓN SUPERIOR DE RETORNO */
        .btn-back {
            position: fixed;
            top: 15px; left: 15px;
            background: rgba(255,255,255,0.1);
            color: white; border: 1px solid #444;
            padding: 8px 15px; font-size: 11px;
            cursor: pointer; text-transform: uppercase;
            z-index: 100; pointer-events: auto;
        }

        /* PANEL DE DESPACHO */
        #panel-despacho {
            display: none;
            background: var(--dark-panel);
            width: 400px;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 15px 50px rgba(0,0,0,0.9);
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }

        .header-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        .btn-close {
            background: none; border: none; color: white;
            font-size: 2rem; cursor: pointer; line-height: 0.8;
        }
        .btn-close:hover { color: var(--danger); }

        /* FORMULARIO */
        .form-group { margin-bottom: 15px; }
        label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px; }
        input, select {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333;
            background: rgba(255,255,255,0.05); color: white; font-size: 1rem;
            box-sizing: border-box;
        }

        .btn-enviar {
            width: 100%; padding: 15px; background: var(--primary);
            border: none; border-radius: 8px; color: white;
            font-weight: bold; font-size: 1rem; cursor: pointer;
            text-transform: uppercase; margin-top: 10px;
        }

        .btn-open-panel {
            padding: 20px 50px;
            background: var(--primary);
            color: white; border: none; border-radius: 50px;
            font-weight: 900; font-size: 1.2rem; cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 10px 30px rgba(230, 126, 34, 0.3);
        }
    </style>
</head>
<body>

    <div id="bg-foto" class="bg-cuartel"></div>

    <div id="map"></div>

    <button class="btn-back" onclick="window.location.href='index.html'">« Volver</button>

    <div class="main-ui">
        <button id="btn-abrir" class="btn-open-panel" onclick="activarDespacho()">NUEVA SALIDA</button>

        <div id="panel-despacho">
            <div class="header-panel">
                <h2 style="margin:0; color:var(--primary);">DESPACHO UNIDAD B1</h2>
                <button class="btn-close" onclick="cerrarYLimpiar()">×</button>
            </div>

            <div class="form-group">
                <label>TIPO DE SINIESTRO</label>
                <select id="tipo-aviso">
                    <option value="ACCIDENTE VIAL">ACCIDENTE VIAL</option>
                    <option value="INCENDIO ESTRUCTURAL">INCENDIO ESTRUCTURAL</option>
                    <option value="RESCATE ACUÁTICO">RESCATE ACUÁTICO</option>
                    <option value="INCENDIO FORESTAL">INCENDIO FORESTAL</option>
                    <option value="AUXILIO PERSONA">AUXILIO PERSONA</option>
                </select>
            </div>

            <div class="form-group">
                <label>DIRECCIÓN (O click en mapa)</label>
                <input type="text" id="direccion" placeholder="Nombre de calle y altura">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label>LATITUD</label>
                    <input type="text" id="lat" readonly>
                </div>
                <div class="form-group">
                    <label>LONGITUD</label>
                    <input type="text" id="lon" readonly>
                </div>
            </div>

            <button class="btn-enviar" onclick="enviarDespacho()">ENVIAR A UNIDAD</button>
        </div>
    </div>

    <script>
        let map, marker, client;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -35.576, lng: -58.010 },
                zoom: 15,
                disableDefaultUI: true,
                styles: [{ "featureType": "all", "stylers": [{ "invert_lightness": true }, { "saturation": -20 }] }]
            });

            map.addListener("click", (e) => {
                const lat = e.latLng.lat().toFixed(6);
                const lon = e.latLng.lng().toFixed(6);
                document.getElementById("lat").value = lat;
                document.getElementById("lon").value = lon;
                if (marker) marker.setMap(null);
                marker = new google.maps.Marker({ position: e.latLng, map: map });
            });
        }

        function activarDespacho() {
            document.getElementById('map').style.display = 'block';
            document.getElementById('bg-foto').style.opacity = '0'; // Se va la foto
            document.getElementById('panel-despacho').style.display = 'block';
            document.getElementById('btn-abrir').style.display = 'none';
        }

        function cerrarYLimpiar() {
            // Revertir a modo espera (foto cuartel)
            document.getElementById('map').style.display = 'none';
            document.getElementById('bg-foto').style.opacity = '1';
            document.getElementById('panel-despacho').style.display = 'none';
            document.getElementById('btn-abrir').style.display = 'block';
            
            // LIMPIEZA TOTAL DE CAMPOS
            document.getElementById('tipo-aviso').selectedIndex = 0;
            document.getElementById('direccion').value = "";
            document.getElementById('lat').value = "";
            document.getElementById('lon').value = "";
            if (marker) marker.setMap(null);
        }

        function conectarMQTT() {
            client = new Paho.MQTT.Client("broker.hivemq.com", 8884, "/mqtt", "CEN_" + Math.random().toString(16).slice(2, 5));
            client.connect({ useSSL: true, onSuccess: () => console.log("Central Conectada") });
        }

        function enviarDespacho() {
            if (!document.getElementById('lat').value) return alert("Debe marcar el lugar en el mapa");
            
            const payload = JSON.stringify({
                aviso: document.getElementById('tipo-aviso').value,
                direccion: document.getElementById('direccion').value,
                lat: document.getElementById('lat').value,
                lon: document.getElementById('lon').value,
                timestamp: Date.now()
            });

            const message = new Paho.MQTT.Message(payload);
            message.destinationName = "bomberos/unidad/B1";
            client.send(message);

            alert("DESPACHO ENVIADO A UNIDAD B1");
            cerrarYLimpiar();
        }

        window.onload = () => {
            conectarMQTT();
            initMap();
        };
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0_KPxSHGYgf-ewC3Cha0yH-ey8-up9ds&callback=initMap" async defer></script>
</body>
</html>
