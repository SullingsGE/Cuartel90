<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>SISTEMA CENTRAL B1 - CHASCOMÚS</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #e67e22; --dark: #0b0e11; --card: rgba(21, 25, 29, 0.95); }
        body, html { margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #000; overflow: hidden; color: white; }
        
        .bg-cuartel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('cuartel.jpg') no-repeat center center; background-size: cover; filter: blur(8px) brightness(0.4); z-index: 1; }
        
        /* Paneles */
        .full-panel { position: fixed; top: 0; left: -100%; width: 100%; height: 100%; transition: 0.4s ease-out; z-index: 1000; display: flex; visibility: hidden; }
        .full-panel.active { left: 0; visibility: visible; }
        
        #map-full { position: absolute; top: 0; left: 0; width: calc(100% - 400px); height: 100%; background: #111; }
        
        /* Pestañas laterales */
        .handle-container { position: fixed; left: 0; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; z-index: 2000; }
        .drawer-handle { width: 45px; height: 180px; background: var(--card); border: 2px solid var(--primary); border-left: none; border-radius: 0 12px 12px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; writing-mode: vertical-rl; text-orientation: mixed; font-weight: bold; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; }
        
        /* Despacho */
        #despacho-control { width: 400px; background: var(--card); padding: 25px; box-sizing: border-box; border-left: 2px solid var(--primary); display: flex; flex-direction: column; position: absolute; right: 0; height: 100%; }
        .panel-header { width: 100%; height: 100px; background: url('escudo.png') no-repeat center; background-size: contain; margin-bottom: 10px; }
        
        /* Bitácora */
        #bitacora-content { width: 100%; height: 100%; background: rgba(11, 14, 17, 0.98); padding: 40px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .input-std { width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.6); border: 1px solid #555; color: white; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .btn-tipo { width: 100%; padding: 10px; margin-bottom: 6px; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; text-transform: uppercase; opacity: 0.6; font-size: 11px; }
        .btn-tipo.selected { opacity: 1; border: 2px solid #fff; }
        .btn-action { width: 100%; padding: 20px; background: var(--primary); border: none; color: white; font-weight: 900; font-size: 18px; cursor: pointer; border-radius: 8px; text-transform: uppercase; }

        #bit-login { max-width: 350px; width: 100%; display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 12px; border: 1px solid var(--primary); }
        #bit-ui { display:none; height: 90%; width: 100%; max-width: 1000px; flex-direction: column; }
        #historial-bit { flex-grow: 1; background: rgba(0,0,0,0.5); overflow-y: auto; margin: 20px 0; padding: 20px; border-radius: 8px; border: 1px solid #444; font-size: 14px; }
        .log-entry { border-left: 4px solid var(--primary); background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-radius: 0 4px 4px 0; }
        
        .close-btn { position: absolute; top: 20px; right: 30px; font-size: 45px; color: white; cursor: pointer; background: none; border: none; z-index: 1100; }
    </style>
</head>
<body>

<div class="bg-cuartel"></div>

<div class="handle-container">
    <div class="drawer-handle" onclick="abrirPanel('panel-despacho')">DESPACHO</div>
    <div class="drawer-handle" onclick="abrirPanel('panel-bitacora')">LIBRO DE GUARDIA</div>
</div>

<div id="panel-despacho" class="full-panel">
    <button class="close-btn" onclick="cerrarPaneles()">×</button>
    <div id="map-full"></div>
    <div id="despacho-control">
        <div class="panel-header"></div> 
        <input id="pac-input" class="input-std" type="text" placeholder="Calle en Chascomús...">
        <div style="margin: 15px 0; flex-grow: 1; overflow-y: auto;">
            <button class="btn-tipo" style="background: #2980b9;" onclick="seleccionar(this, 'RESCATE PERS/ANIMAL')">RESCATE PERS/ANIMAL</button>
            <button class="btn-tipo" style="background: #2980b9;" onclick="seleccionar(this, 'RESCATE TECNICO')">RESCATE TECNICO</button>
            <button class="btn-tipo" style="background: #f1c40f; color:black;" onclick="seleccionar(this, 'ACCIDENTE')">ACCIDENTE</button>
            <button class="btn-tipo" style="background: #c0392b;" onclick="seleccionar(this, 'INCENDIO FORESTAL')">INCENDIO FORESTAL</button>
            <button class="btn-tipo" style="background: #c0392b;" onclick="seleccionar(this, 'INCENDIO ESTRUCTURAL')">INCENDIO ESTRUCTURAL</button>
            <button class="btn-tipo" style="background: #c0392b;" onclick="seleccionar(this, 'INCENDIO VEHICULAR')">INCENDIO VEHICULAR</button>
        </div>

        <button class="btn-action" onclick="ejecutarDespacho()">REGISTRAR SALIDA</button>
    </div>
</div>

<div id="panel-bitacora" class="full-panel">
    <button class="close-btn" onclick="cerrarPaneles()">×</button>
    <div id="bitacora-content">
        <h2 style="color:var(--primary); font-size: 35px; margin-bottom: 20px;">LIBRO DE GUARDIA</h2>
        
        <div id="bit-login">
            <h3 style="margin-top:0; font-size:14px; text-align:center;">INGRESO DE PERSONAL</h3>
            <input type="text" id="u-bit" class="input-std" placeholder="Usuario">
            <input type="password" id="p-bit" class="input-std" placeholder="Contraseña">
            <button class="btn-action" onclick="loginBitacora()" style="padding:15px; font-size:14px;">ACCEDER</button>
        </div>

        <div id="bit-ui">
            <div id="historial-bit"></div>
            <div style="display:flex; gap:10px; align-items: flex-end;">
                <textarea id="text-novedad" class="input-std" style="height:80px; resize:none;" placeholder="Escriba la novedad aquí..."></textarea>
                <button class="btn-action" style="width:150px; height:80px; font-size:14px;" onclick="guardarNovedad()">GRABAR</button>
            </div>
        </div>
    </div>
</div>

<script>
    let map, marker, lat, lon, tipoSeleccionado = "";
    let usuarioLogueado = "";

    const firebaseConfig = {
        apiKey: "AIzaSyBMNFRm_snxnwtU0sy9-q0zyfBcSzKOtS8",
        databaseURL: "https://bomberoschascomus90-default-rtdb.firebaseio.com",
        projectId: "bomberoschascomus90",
        appId: "1:138882346793:web:b069ff3e6d746d64c6d138"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function abrirPanel(id) {
        cerrarPaneles();
        document.getElementById(id).classList.add('active');
        if(id === 'panel-despacho' && map) {
            setTimeout(() => { google.maps.event.trigger(map, "resize"); }, 400);
        }
    }

    function cerrarPaneles() { 
        document.querySelectorAll('.full-panel').forEach(p => p.classList.remove('active')); 
    }

    function seleccionar(btn, tipo) {
        document.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        tipoSeleccionado = tipo;
    }

    function ejecutarDespacho() {
        let inputCalle = document.getElementById('pac-input');
        if (!tipoSeleccionado || !lat) return alert("Faltan datos de siniestro o ubicación.");

        // Guardar en Firebase local para historial si lo deseas, o solo limpiar campos
        alert("DESPACHO REGISTRADO LOCALMENTE");

        // VACIAR CAMPOS (Cumpliendo tu instrucción de limpieza)
        inputCalle.value = "";
        tipoSeleccionado = "";
        document.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('selected'));
        if (marker) marker.setMap(null);
        lat = null; lon = null;
    }

    function loginBitacora() {
        const u = document.getElementById('u-bit').value.toLowerCase().trim();
        const p = document.getElementById('p-bit').value;
        db.ref('usuarios/' + u).once('value', snap => {
            if (snap.exists() && snap.val().password === p) {
                usuarioLogueado = u.toUpperCase();
                document.getElementById('bit-login').style.display = 'none';
                document.getElementById('bit-ui').style.display = 'flex';
                vincularBitacora();
            } else { alert("Usuario o clave incorrectos"); }
        });
    }

    function vincularBitacora() {
        db.ref('bitacora').limitToLast(50).on('value', snap => {
            const box = document.getElementById('historial-bit');
            box.innerHTML = "";
            snap.forEach(child => {
                const item = child.val();
                box.innerHTML += `<div class="log-entry"><b>[${item.fecha}] ${item.usuario}:</b> ${item.texto}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    function guardarNovedad() {
        const text = document.getElementById('text-novedad');
        if(!text.value.trim()) return;
        db.ref('bitacora').push({
            usuario: usuarioLogueado,
            fecha: new Date().toLocaleDateString('es-AR'),
            texto: text.value.trim()
        });
        text.value = "";
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById("map-full"), {
            zoom: 14, center: { lat: -35.576, lng: -58.010 },
            styles: [{ "featureType": "all", "stylers": [{ "invert_lightness": true }] }]
        });
        const bounds = new google.maps.LatLngBounds(new google.maps.LatLng(-35.9, -58.3), new google.maps.LatLng(-35.4, -57.7));
        const auto = new google.maps.places.Autocomplete(document.getElementById("pac-input"), {
            bounds: bounds, strictBounds: true
        });
        auto.addListener("place_changed", () => {
            const p = auto.getPlace(); if (!p.geometry) return;
            lat = p.geometry.location.lat(); lon = p.geometry.location.lng();
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({ position: {lat, lng: lon}, map: map });
            map.panTo({lat, lng: lon});
        });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0_KPxSHGYgf-ewC3Cha0yH-ey8-up9ds&libraries=places&callback=initMap" async defer></script>
</body>
</html>
