<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Unidad B1 - Terminal Táctica</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        body { margin: 0; background: #121212; color: white; font-family: sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        #header { 
            position: absolute; top: 0; width: 100%; z-index: 1000; 
            background: #2c3e50; padding: 15px; text-align: center; 
            font-weight: bold; border-bottom: 3px solid #e67e22; transition: 0.5s;
        }
        #console { 
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); 
            height: 60px; font-size: 11px; padding: 10px; color: #0f0; z-index: 2000;
            pointer-events: none; overflow-y: hidden;
        }
    </style>
</head>
<body>
    <div id="header">ESPERANDO SEÑAL GPS...</div>
    <div id="console">> Iniciando sistema...</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <script>
        const log = (m) => { document.getElementById('console').innerHTML = "> " + m; };
        var map = L.map('map', {zoomControl: false}).setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var miPosicion = null;
        var marcadorUnidad = null;
        var rutaActual = null;

        // GPS
        map.on('locationfound', (e) => {
            miPosicion = e.latlng;
            if (!marcadorUnidad) {
                marcadorUnidad = L.circleMarker(miPosicion, {radius: 9, color: '#3498db', fillColor: '#3498db', fillOpacity: 0.9}).addTo(map);
                map.setView(miPosicion, 16);
                log("GPS: Posición fijada");
            } else {
                marcadorUnidad.setLatLng(miPosicion);
                if (rutaActual) rutaActual.spliceWaypoints(0, 1, miPosicion);
            }
        });
        map.locate({watch: true, enableHighAccuracy: true});

        // MQTT Celular
        var client = new Paho.MQTT.Client("wss://broker.hivemq.com:8884/mqtt", "CEL_B1_" + Math.random().toString(16).substr(2, 4));
        
        client.onMessageArrived = (msg) => {
            const data = JSON.parse(msg.payloadString);
            log("ALERTA: " + data.aviso);
            document.getElementById('header').innerText = "ALERTA: " + data.aviso;
            document.getElementById('header').style.background = "#c0392b";

            const destino = L.latLng(data.lat, data.lon);
            if (rutaActual) map.removeControl(rutaActual);
            
            rutaActual = L.Routing.control({
                waypoints: [miPosicion || map.getCenter(), destino],
                lineOptions: { styles: [{ color: '#e67e22', weight: 7 }] },
                createMarker: function() { return null; },
                addWaypoints: false
            }).addTo(map);
            map.flyTo(destino, 15);
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        };

        function conectar() {
            client.connect({
                useSSL: true,
                onSuccess: () => {
                    log("CONECTADO A CENTRAL");
                    document.getElementById('header').innerText = "UNIDAD B1 - LISTA";
                    document.getElementById('header').style.background = "#27ae60";
                    client.subscribe("bomberos/unidad/B1", {qos: 1});
                },
                onFailure: () => { log("Reintentando conexión..."); setTimeout(conectar, 5000); }
            });
        }
        conectar();
    </script>
</body>
</html>
