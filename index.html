<HTML>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Terminal T√°ctica de Emergencia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        body { margin: 0; padding: 0; background: #121212; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        #header {
            position: absolute; top: 0; width: 100%; z-index: 1000;
            background: #c0392b; color: white; text-align: center;
            padding: 12px 0; font-weight: bold; font-size: 1.1em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        #log-status {
            position: absolute; bottom: 80px; left: 10px; z-index: 1000;
            background: rgba(0,0,0,0.7); color: #00ff00;
            padding: 5px 10px; border-radius: 4px; font-size: 0.8em;
            pointer-events: none;
        }

        #controls {
            position: absolute; bottom: 20px; right: 10px; z-index: 1000;
        }

        .btn-follow {
            background: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.4);
            font-size: 20px; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="header">CONECTANDO A CENTRAL...</div>
    <div id="log-status">Sistema Iniciado</div>
    
    <div id="controls">
        <button class="btn-follow" onclick="toggleFollow()">üìç</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- CONFIGURACI√ìN DE MAPAS ---
        var map = L.map('map', { zoomControl: false }).setView([0, 0], 18);
        var followPlayer = true;
        var userMarker, routingControl;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var fireIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#e74c3c; width:15px; height:15px; border-radius:50%; border:3px solid white; box-shadow: 0 0 10px rgba(231,76,60,0.8);'></div>",
            iconSize: [20, 20], iconAnchor: [10, 10]
        });

        // --- CONFIGURACI√ìN MQTT (COMUNICACI√ìN) ---
        var clienteId = "unidad_" + Math.floor(Math.random() * 10000);
        var client = new Paho.MQTT.Client("wss://broker.hivemq.com:443/mqtt", clienteId);

        client.onConnectionLost = function(responseObject) {
            document.getElementById('header').innerText = "CONEXI√ìN PERDIDA";
            document.getElementById('header').style.background = "#555";
        };

        client.onMessageArrived = function(message) {
            try {
                var data = JSON.parse(message.payloadString);
                log("Mensaje Recibido: " + data.aviso);
                navegarA(data.lat, data.lon, data.aviso);
            } catch(e) {
                log("Error en formato de mensaje");
            }
        };

        client.connect({ 
            onSuccess: function() {
                document.getElementById('header').innerText = "ESPERANDO SERVICIO";
                document.getElementById('header').style.background = "#27ae60";
                log("MQTT Conectado en puerto 443");
                client.subscribe("bomberos/unidad/B1");
            },
            useSSL: true,
            onFailure: function(e) {
                log("Fallo de conexi√≥n: " + e.errorMessage);
            }
        });

        // --- L√ìGICA DE NAVEGACI√ìN ---
        function onLocationFound(e) {
            var latlng = e.latlng;
            if (!userMarker) {
                userMarker = L.marker(latlng, {icon: fireIcon}).addTo(map);
                log("GPS Localizado");
            } else {
                userMarker.setLatLng(latlng);
                if (routingControl) {
                    routingControl.spliceWaypoints(0, 1, latlng);
                }
            }
            if (followPlayer) map.setView(latlng, 18);
        }

        function navegarA(lat, lon, texto) {
            document.getElementById('header').innerText = "ALERTA: " + texto;
            document.getElementById('header').style.background = "#c0392b";
            var destino = L.latLng(lat, lon);

            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [userMarker.getLatLng(), destino],
                lineOptions: { styles: [{ color: '#3498db', weight: 8, opacity: 0.8 }] },
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                createMarker: function() { return null; }
            }).addTo(map);

            map.flyTo(destino, 16);
        }

        function toggleFollow() {
            followPlayer = !followPlayer;
            log(followPlayer ? "Siguiendo" : "Mapa Libre");
        }

        function log(msg) {
            document.getElementById('log-status').innerText = msg;
            console.log(msg);
        }

        map.on('locationfound', onLocationFound);
        map.locate({ setView: true, watch: true, enableHighAccuracy: true });

    </script>
</body>
</html>

