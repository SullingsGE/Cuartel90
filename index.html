<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Terminal T谩ctica de Emergencia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        body { margin: 0; padding: 0; background: #121212; font-family: sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        #header {
            position: absolute; top: 0; width: 100%; z-index: 1000;
            background: #2c3e50; color: white; text-align: center;
            padding: 15px 0; font-weight: bold; font-size: 1.1em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            transition: background 0.5s;
        }

        #log-status {
            position: absolute; bottom: 80px; left: 10px; z-index: 1000;
            background: rgba(0,0,0,0.8); color: #00ff00;
            padding: 5px 10px; border-radius: 4px; font-size: 0.75em;
            font-family: monospace;
        }

        #controls {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
        }

        .btn-follow {
            background: white; border: none; width: 60px; height: 60px;
            border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="header">INICIALIZANDO SISTEMA...</div>
    <div id="log-status">Cargando m贸dulos...</div>
    
    <div id="controls">
        <button class="btn-follow" onclick="toggleFollow()"></button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- 1. CONFIGURACIN DE MAPAS ---
        var map = L.map('map', { zoomControl: false }).setView([0, 0], 18);
        var followPlayer = true;
        var userMarker, routingControl;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var fireIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#e74c3c; width:16px; height:16px; border-radius:50%; border:3px solid white; box-shadow: 0 0 12px rgba(231,76,60,0.9);'></div>",
            iconSize: [22, 22], iconAnchor: [11, 11]
        });

        // --- 2. CONFIGURACIN MQTT (CONEXIN SEGURA 443) ---
        var host = "broker.emqx.io";
        var port = 443;
        var path = "/mqtt";
        var clienteId = "unidad_" + Math.floor(Math.random() * 10000);

        var client = new Paho.MQTT.Client("wss://" + host + ":" + port + path, clienteId);

        client.onConnectionLost = function(responseObject) {
            document.getElementById('header').innerText = "CONEXIN PERDIDA";
            document.getElementById('header').style.background = "#555";
            log("Conexi贸n perdida. Reintentando...");
            setTimeout(conectarCentral, 5000);
        };

        client.onMessageArrived = function(message) {
            try {
                var data = JSON.parse(message.payloadString);
                log("AVISO RECIBIDO: " + data.aviso);
                navegarA(data.lat, data.lon, data.aviso);
            } catch(e) {
                log("Error: Mensaje JSON inv谩lido");
            }
        };

        function conectarCentral() {
            log("Conectando a central...");
            client.connect({ 
                useSSL: true,
                timeout: 10,
                keepAliveInterval: 30,
                onSuccess: function() {
                    document.getElementById('header').innerText = "ESPERANDO SERVICIO";
                    document.getElementById('header').style.background = "#27ae60";
                    log("CONECTADO A EMQX (443)");
                    client.subscribe("bomberos/unidad/B1");
                },
                onFailure: function(e) {
                    log("Fallo: " + e.errorMessage);
                    document.getElementById('header').innerText = "ERROR DE RED";
                    document.getElementById('header').style.background = "#000";
                    setTimeout(conectarCentral, 5000);
                }
            });
        }

        // --- 3. LGICA DE NAVEGACIN Y GPS ---
        function onLocationFound(e) {
            var latlng = e.latlng;
            if (!userMarker) {
                userMarker = L.marker(latlng, {icon: fireIcon}).addTo(map);
                log("GPS: Se帽al fija");
                map.setView(latlng, 18);
            } else {
                userMarker.setLatLng(latlng);
                // Si hay una ruta activa, actualizamos el punto de inicio (nuestra posici贸n)
                if (routingControl) {
                    routingControl.spliceWaypoints(0, 1, latlng);
                }
            }
            if (followPlayer) map.panTo(latlng);
        }

        function navegarA(lat, lon, texto) {
            document.getElementById('header').innerText = "ALERTA: " + texto;
            document.getElementById('header').style.background = "#c0392b";
            var destino = L.latLng(lat, lon);

            // Limpiamos ruta anterior si existe
            if (routingControl) {
                map.removeControl(routingControl);
            }

            // Calculamos nueva ruta
            routingControl = L.Routing.control({
                waypoints: [userMarker.getLatLng(), destino],
                lineOptions: { styles: [{ color: '#3498db', weight: 8, opacity: 0.8 }] },
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                createMarker: function() { return null; }, // No pines extra
                addWaypoints: false,
                draggableWaypoints: false
            }).addTo(map);

            map.flyTo(destino, 16);
            
            // Vibraci贸n (si el celular lo permite)
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }

        function toggleFollow() {
            followPlayer = !followPlayer;
            log(followPlayer ? "Modo: Seguimiento" : "Modo: Mapa Libre");
        }

        function log(msg) {
            document.getElementById('log-status').innerText = msg;
            console.log(msg);
        }

        // Iniciar servicios
        map.on('locationfound', onLocationFound);
        map.on('locationerror', function(e) { log("Error GPS: " + e.message); });
        
        map.locate({ setView: false, watch: true, enableHighAccuracy: true });
        conectarCentral();

    </script>
</body>
</html>



