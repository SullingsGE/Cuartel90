<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Test Final</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #121212; color: white; }
        #map { height: 100vh; width: 100vw; }
        #header {
            position: absolute; top: 0; width: 100%; z-index: 1000;
            background: #2c3e50; padding: 20px 0; text-align: center; font-weight: bold;
        }
        #debug {
            position: absolute; bottom: 10px; left: 10px; z-index: 1000;
            background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="header">ESTADO: INICIANDO...</div>
    <div id="debug">Log: Esperando...</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Log para ver errores en el celular
        function log(t) { document.getElementById('debug').innerText = t; console.log(t); }

        // 1. Mapa Simple
        var map = L.map('map').setView([40.41, -3.70], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // 2. MQTT con configuración de máxima compatibilidad
        var clientId = "user_" + Math.floor(Math.random() * 1000);
        // Usamos la URL completa para no dejar dudas al navegador
        var client = new Paho.MQTT.Client("wss://broker.emqx.io:443/mqtt", clientId);

        client.onMessageArrived = function(msg) {
            log("¡MENSAJE RECIBIDO!");
            var d = JSON.parse(msg.payloadString);
            document.getElementById('header').innerText = "AVISO: " + d.aviso;
            document.getElementById('header').style.background = "red";
            L.marker([d.lat, d.lon]).addTo(map).bindPopup(d.aviso).openPopup();
            map.flyTo([d.lat, d.lon], 16);
        };

        var options = {
            useSSL: true,
            timeout: 3,
            onSuccess: function() {
                log("CONECTADO OK");
                document.getElementById('header').innerText = "ESPERANDO SERVICIO";
                document.getElementById('header').style.background = "green";
                client.subscribe("bomberos/unidad/B1");
            },
            onFailure: function(e) {
                log("FALLO: " + e.errorMessage);
                // Intento de reconexión automática
                setTimeout(function(){ location.reload(); }, 5000);
            }
        };

        log("Llamando a connect...");
        client.connect(options);
    </script>
</body>
</html>
