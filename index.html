<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

<script>
// 1. Configuración de Conexión
var clienteId = "unidad_bomberos_" + Math.random().toString(16).substr(2, 8);
var client = new Paho.MQTT.Client("broker.hivemq.com", 8000, clienteId);

client.onMessageArrived = function(message) {
    // Aquí llega la orden remota
    var data = JSON.parse(message.payloadString);
    console.log("Nueva Emergencia Recibida:", data);
    
    // Llamamos a la función de navegación con los datos remotos
    navegarA(data.lat, data.lon, data.aviso);
};

client.connect({ onSuccess: function() {
    console.log("Conectado al Despacho Central");
    // Nos suscribimos al canal de nuestra unidad
    client.subscribe("bomberos/unidad/B1");
}});

function navegarA(lat, lon, texto) {
    document.getElementById('header').innerText = "AVISO: " + texto;
    var destino = L.latLng(lat, lon);
    
    if (routingControl) {
        routingControl.setWaypoints([userMarker.getLatLng(), destino]);
    }
    map.flyTo(destino, 16);
}
</script>
