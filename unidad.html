<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNIDAD B1 - CHASCOM칔S</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #e67e22; --danger: #c0392b; --success: #27ae60; --dark: #0f0f0f; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #000; color: white; overflow-x: hidden; }
        .bg-unidad { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('camion2.jpg') center/cover; z-index: 1; }
        .main-container { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%; }
        .status-bar { background: var(--danger); padding: 15px; text-align: center; font-weight: bold; text-transform: uppercase; }
        .navigation-zone { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #alerta-info-box { display: none; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 12px; border-left: 8px solid var(--primary); width: 90%; max-width: 450px; }
        .controls { background: var(--dark); padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-op { padding: 20px; border: none; border-radius: 10px; color: white; font-weight: 900; text-transform: uppercase; cursor: pointer; }
        
        /* FORMULARIO ESTILO CHASCOM칔S */
        #form-parte { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 10000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .seccion-titulo { background: var(--primary); color: white; padding: 8px; margin: 15px 0 10px 0; font-weight: bold; text-transform: uppercase; font-size: 14px; }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-f { width: 100%; padding: 12px; margin-bottom: 5px; background: #2b2b2b; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        label { font-size: 11px; color: #aaa; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="bg-unidad"></div>
    <div class="main-container">
        <div class="status-bar" id="status-txt">游 UNIDAD B1: DISPONIBLE</div>
        <div class="navigation-zone">
            <div id="alerta-info-box">
                <h2 id="txt-evento" style="color:var(--primary); margin:0;"></h2>
                <p id="txt-dir" style="font-size: 1.3rem; margin: 10px 0;"></p>
            </div>
        </div>
        <div class="controls">
            <button class="btn-op" style="background:var(--primary)" onclick="enviarEstado('LLEGADA')">LLEGADA</button>
            <button class="btn-op" style="background:var(--success)" onclick="abrirFormulario()">FINALIZAR</button>
        </div>
    </div>

    <div id="form-parte">
        <h3 style="text-align:center; margin:0;">ACTA DE ACCIDENTE - B.V. CHASCOM칔S</h3>
        
        <div class="seccion-titulo">Horarios</div>
        <div class="grid-form">
            <div><label>Llamado</label><input type="time" id="h-llamado" class="input-f"></div>
            <div><label>Llegada Lugar</label><input type="time" id="h-llegada" class="input-f"></div>
            <div><label>Fin Trabajo</label><input type="time" id="h-fin" class="input-f"></div>
            <div><label>Llegada Cuartel</label><input type="time" id="h-cuartel" class="input-f"></div>
        </div>

        <div class="seccion-titulo">Localizaci칩n</div>
        <input type="text" id="f-calle" class="input-f" placeholder="Calle / Ruta / KM">
        <input type="text" id="f-entre" class="input-f" placeholder="Entre calles">

        <div class="seccion-titulo">Damnificados / Intervinientes</div>
        <div class="grid-form">
            <div><label>Civiles Heridos</label><input type="number" id="d-heridos" class="input-f" value="0"></div>
            <div><label>Civiles Fallecidos</label><input type="number" id="d-fallecidos" class="input-f" value="0"></div>
        </div>

        <div class="seccion-titulo">Veh칤culos Afectados</div>
        <input type="text" id="v-marca" class="input-f" placeholder="Marca y Modelo">
        <input type="text" id="v-dominio" class="input-f" placeholder="Dominio (Patente)">
        <input type="text" id="v-seguro" class="input-f" placeholder="Compa침칤a de Seguros">

        <div class="seccion-titulo">Responsables</div>
        <input type="text" id="r-dotacion" class="input-f" placeholder="Jefe de Dotaci칩n">
        <input type="text" id="r-policia" class="input-f" placeholder="Polic칤a a cargo">
        <input type="text" id="r-medico" class="input-f" placeholder="M칠dico a cargo">

        <textarea id="f-obs" class="input-f" style="height:80px; margin-top:10px;" placeholder="Observaciones generales..."></textarea>

        <button class="btn-op" style="background:var(--success); width:100%;" onclick="generarPDFFinal()">GENERAR PDF OFICIAL</button>
        <button class="btn-op" style="background:#444; width:100%; margin-top:10px;" onclick="cerrarFormulario()">CANCELAR</button>
    </div>

    <script>
        let datosMQTT = { aviso: "ACCIDENTE", direccion: "" };

        function abrirFormulario() { document.getElementById('form-parte').style.display = 'flex'; }
        function cerrarFormulario() { document.getElementById('form-parte').style.display = 'none'; }

        function generarPDFFinal() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const width = doc.internal.pageSize.getWidth();

            // Encabezado Oficial 
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text("SOCIEDAD DE BOMBEROS VOLUNTARIOS DE CHASCOMUS", width/2, 15, {align: "center"});
            doc.setFontSize(9); doc.setFont("helvetica", "normal");
            doc.text("Fundada el 19 de Noviembre de 1960 | Soler 347 - Tel: 02241 42 4059", width/2, 20, {align: "center"});
            doc.line(15, 25, 195, 25);

            // T칤tulo del reporte [cite: 3]
            doc.setFontSize(16); doc.setFont("helvetica", "bold");
            doc.text("ACTA DE " + datosMQTT.aviso, width/2, 35, {align: "center"});

            // Datos rellenados [cite: 7, 12, 46, 54]
            const rows = [
                ["FECHA", new Date().toLocaleDateString(), "LOCALIZACI칍N", document.getElementById('f-calle').value],
                ["HORA LLAMADO", document.getElementById('h-llamado').value, "HORA LLEGADA", document.getElementById('h-llegada').value],
                ["HERIDOS", document.getElementById('d-heridos').value, "FALLECIDOS", document.getElementById('d-fallecidos').value],
                ["VEH칈CULO", document.getElementById('v-marca').value, "DOMINIO", document.getElementById('v-dominio').value],
                ["SEGURO", document.getElementById('v-seguro').value, "POLIC칈A A CARGO", document.getElementById('r-policia').value],
                ["M칄DICO A CARGO", document.getElementById('r-medico').value, "JEFE DOTACI칍N", document.getElementById('r-dotacion').value]
            ];

            doc.autoTable({
                startY: 45,
                body: rows,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 3 },
                columnStyles: { 0: {fontStyle: 'bold', fillColor: [240, 240, 240]}, 2: {fontStyle: 'bold', fillColor: [240, 240, 240]} }
            });

            doc.setFont("helvetica", "bold");
            doc.text("OBSERVACIONES:", 15, doc.lastAutoTable.finalY + 15);
            doc.setFont("helvetica", "normal");
            const obs = doc.splitTextToSize(document.getElementById('f-obs').value, 170);
            doc.text(obs, 15, doc.lastAutoTable.finalY + 22);

            // Firmas 
            const finalY = doc.internal.pageSize.getHeight() - 30;
            doc.line(20, finalY, 80, finalY); doc.text("JEFE DE DOTACI칍N", 35, finalY + 5);
            doc.line(130, finalY, 190, finalY); doc.text("POLIC칈A / RESPONSABLE", 140, finalY + 5);

            doc.save(`ACTA_B1_${Date.now()}.pdf`);
            cerrarFormulario();
        }
        
        // Simulaci칩n de recepci칩n de datos para pruebas
        window.onload = () => {
            // Aqu칤 ir칤a tu l칩gica MQTT previa
        };
    </script>
</body>
</html>
