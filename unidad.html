<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNIDAD B1 - CHASCOM√öS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
    <style>
        :root { --primary: #e67e22; --danger: #c0392b; --success: #27ae60; --dark: rgba(10, 10, 10, 0.85); }
        
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Segoe UI', sans-serif; background: #000; color: white; overflow: hidden; }

        /* FONDO CON FOTO REAL */
        .bg-unidad {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('camion2.jpg');
            background-size: cover; background-position: center;
            z-index: 1;
        }

        /* CAPA OPERATIVA */
        .main-container {
            position: relative; z-index: 10;
            display: flex; flex-direction: column; height: 100%;
        }

        /* Barra Superior */
        .status-bar {
            background: var(--danger); color: white; padding: 10px;
            text-align: center; font-weight: bold; font-size: 1.2rem;
            letter-spacing: 1px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* √Årea de Mapa */
        #map-unidad { flex-grow: 1; width: 100%; background: #1a1a1a; }

        /* Panel de Alerta (Se activa cuando llega despacho) */
        #alerta-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 5000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            animation: flash red 1s infinite;
        }
        @keyframes flash { 0% { background: rgba(0,0,0,0.9); } 50% { background: rgba(192, 57, 43, 0.5); } 100% { background: rgba(0,0,0,0.9); } }

        /* Botonera Inferior */
        .controls {
            background: var(--dark); padding: 15px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }

        .btn-op {
            padding: 20px; border: none; border-radius: 8px; color: white;
            font-weight: 900; font-size: 1rem; text-transform: uppercase; cursor: pointer;
        }
        .btn-llegada { background: var(--primary); }
        .btn-finalizar { background: var(--success); }

        /* Notificaci√≥n Toast */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--success); padding: 15px 30px; border-radius: 50px;
            font-weight: bold; z-index: 6000; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div class="bg-unidad"></div>
    <div id="toast" class="toast">‚úÖ MENSAJE ENVIADO A CENTRAL</div>

    <div class="main-container">
        <div class="status-bar" id="status-txt">UNIDAD B1: ESPERANDO DESPACHO</div>
        
        <div id="map-unidad"></div>

        <div class="controls">
            <button class="btn-op btn-llegada" onclick="enviarEstado('LLEGADA AL LUGAR')">LLEGADA AL LUGAR</button>
            <button class="btn-op btn-finalizar" onclick="enviarEstado('SERVICIO FINALIZADO')">FINALIZAR Y RETORNAR</button>
        </div>
    </div>

    <div id="alerta-overlay" onclick="aceptarAlerta()">
        <h1 style="font-size: 3rem; color: #f1c40f;">‚ö†Ô∏è ALERTA ENTRANTE ‚ö†Ô∏è</h1>
        <div id="alerta-info" style="text-align: center; margin: 30px; font-size: 1.5rem;"></div>
        <button class="btn-op" style="background: white; color: black; padding: 20px 50px;">RECIBIDO / IR AL MAPA</button>
    </div>

    <script>
        let map, marker, client;

        function mostrarToast(txt) {
            const t = document.getElementById('toast');
            t.innerText = txt; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function conectarMQTT() {
            client = new Paho.MQTT.Client("broker.hivemq.com", 8884, "/mqtt", "B1_UNID_" + Math.random().toString(16).slice(2, 5));
            client.onMessageArrived = (msg) => {
                const data = JSON.parse(msg.payloadString);
                const info = `üöë EVENTO: ${data.aviso}<br>üìç DIR: ${data.direccion}`;
                document.getElementById('alerta-info').innerHTML = info;
                document.getElementById('alerta-overlay').style.display = 'flex';
                actualizarMapa(data.lat, data.lon);
            };

            client.connect({ useSSL: true, onSuccess: () => {
                client.subscribe("bomberos/unidad/B1");
                console.log("Conectado a Central");
            }});
        }

        function aceptarAlerta() {
            document.getElementById('alerta-overlay').style.display = 'none';
            document.getElementById('status-txt').innerText = "EN SERVICIO ACTIVAMENTE";
            document.getElementById('status-txt').style.background = "#27ae60";
        }

        function enviarEstado(estado) {
            if (client && client.isConnected()) {
                const msg = new Paho.MQTT.Message(JSON.stringify({ 
                    unidad: "B1", 
                    estado: estado, 
                    time: new Date().toLocaleTimeString() 
                }));
                msg.destinationName = "bomberos/central/reportes";
                client.send(msg);
                mostrarToast("‚úÖ " + estado + " REGISTRADO");
                if(estado === 'SERVICIO FINALIZADO') {
                    document.getElementById('status-txt').innerText = "UNIDAD B1: DISPONIBLE";
                    document.getElementById('status-txt').style.background = "#c0392b";
                }
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map-unidad"), {
                zoom: 15, center: { lat: -35.576, lng: -58.010 },
                disableDefaultUI: true,
                styles: [{ "featureType": "all", "stylers": [{ "invert_lightness": true }] }]
            });
            conectarMQTT();
        }

        function actualizarMapa(lat, lon) {
            const pos = { lat: parseFloat(lat), lng: parseFloat(lon) };
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({ position: pos, map: map, animation: google.maps.Animation.BOUNCE });
            map.panTo(pos);
            map.setZoom(17);
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0_KPxSHGYgf-ewC3Cha0yH-ey8-up9ds&callback=initMap" async defer></script>
</body>
</html>
